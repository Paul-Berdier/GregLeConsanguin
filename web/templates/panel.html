<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>🎩 Greg le Consanguin - Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Bienvenue {{ user.username }} 👑</h1>
        <p>Choisis un serveur et un salon vocal pour faire exécuter les ordres par Greg.</p>

        <form id="select-form">
            <label for="guild">🎭 Serveur :</label>
            <select id="guild" name="guild">
                {% for g in user.guilds %}
                    <option value="{{ g.id }}">{{ g.name }}</option>
                {% endfor %}
            </select>

            <label for="channel">🔊 Salon vocal :</label>
            <select id="channel" name="channel">
                <!-- À remplir dynamiquement avec JS -->
            </select>

            <button type="submit">🎮 Contrôler Greg</button>
        </form>

        <hr>

        <div id="controls" style="display:none;">
            <input type="text" id="music-url" placeholder="Lien ou recherche musique…">
            <button onclick="sendCommand('play')">🎵 Play</button>
            <button onclick="sendCommand('skip')">⏭ Skip</button>
            <button onclick="sendCommand('stop')">⏹ Stop</button>
        </div>
    </div>

    <script>
        const form = document.getElementById("select-form");
        const controls = document.getElementById("controls");
        const guildSelect = document.getElementById("guild");
        const channelSelect = document.getElementById("channel");

        // 🧠 Mock : À remplacer par un appel réel à ton bot pour récupérer les salons vocaux
        const dummyChannels = {
            "guild_id_1": [{id: "123", name: "Général"}, {id: "124", name: "Chill"}],
            "guild_id_2": [{id: "555", name: "Musique"}]
        };

        guildSelect.addEventListener("change", function () {
            const guildId = this.value;
            channelSelect.innerHTML = "";
            const chans = dummyChannels[guildId] || [];
            chans.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c.id;
                opt.innerText = c.name;
                channelSelect.appendChild(opt);
            });
        });

        form.addEventListener("submit", function (e) {
            e.preventDefault();
            controls.style.display = "block";
        });

        function sendCommand(action) {
            const guild_id = guildSelect.value;
            const channel_id = channelSelect.value;
            const url = document.getElementById("music-url").value;

            fetch(`/api/command/${action}`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({guild_id, channel_id, url})
            }).then(r => r.json()).then(res => {
                console.log("Commande envoyée :", res);
            });
        }
    </script>
</body>
</html>
