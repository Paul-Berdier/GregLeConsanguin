<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Panel â€“ Greg le Consanguin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
      window.USER_ID = "{{ user['id'] }}";
      window.GUILD_ID = "{{ guild_id }}";
      window.CHANNEL_ID = "{{ channel_id }}";
    </script>
</head>
<body>
    <div class="container">
        <img src="{{ url_for('static', filename='assets/greg.jpg') }}" alt="Greg le Consanguin" class="greg-face">
        <h1>Panneau de Greg le Consanguin</h1>
        <p class="sarcasme">
            Vous voilÃ  ici... on ne vous a jamais dit dâ€™avoir meilleur goÃ»t ?
        </p>
        <div style="text-align: right;">
            <a href="/select"><button>â‡¦ Changer de serveur/salon</button></a>
        </div>

        <form id="play-form" autocomplete="off" style="margin-top:18px;">
            <input id="music-input" type="text" placeholder="Colle une URL ou cherche un son..." autocomplete="off" />
            <div id="suggestions" class="suggestions"></div>
            <button type="submit" id="play-btn">ðŸŽµ Joue Ã§a, Greg</button>
        </form>

        <div id="play-error" style="color:#e84c4c;display:none;margin:8px 0;"></div>

        <div class="controls">
            <button data-action="play">Play</button>
            <button data-action="pause">Pause</button>
            <button data-action="resume">Resume</button>
            <button data-action="skip">Skip</button>
            <button data-action="stop">Stop</button>
        </div>

        <div class="current-song" id="current-song"></div>
        <div class="playlist">
            <h2>Playlist en attente</h2>
            <ul id="playlist-ul">
                {% if playlist %}
                    {% for song in playlist %}
                        <li>
                            <a href="{{ song.url }}" target="_blank">{{ song.title }}</a>
                        </li>
                    {% endfor %}
                {% else %}
                    <p><em>La playlist est vide. Comme votre inspiration.</em></p>
                {% endif %}
            </ul>
        </div>
        <a href="/logout"><button>DÃ©connexion</button></a>
    </div>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
    // == JS gestion panel Greg ==
    const playForm = document.getElementById('play-form');
    const playBtn = document.getElementById('play-btn');
    const input = document.getElementById('music-input');
    const playlistUl = document.getElementById('playlist-ul');
    const playError = document.getElementById('play-error');

    // UtilisÃ© pour empÃªcher le spam Play
    let isPlayingRequest = false;

    playForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (isPlayingRequest) return;
        const value = input.value.trim();
        if (!value) return;

        playError.style.display = "none";
        playBtn.disabled = true;
        isPlayingRequest = true;

        // On tente dâ€™autocomplÃ©ter pour rÃ©cupÃ©rer titre + url
        let item = {title: value, url: value}; // fallbackÂ : si câ€™est une URL
        try {
            const res = await fetch(`/autocomplete?q=${encodeURIComponent(value)}`);
            const json = await res.json();
            if (json.results && json.results.length > 0) {
                item = json.results[0]; // On prend le meilleur rÃ©sultat
            }
        } catch {}

        // OptimisteÂ : on affiche direct dans la playlist (sera refresh ensuite via socket)
        addTrackToPlaylist(item);

        try {
            const payload = {
                title: item.title,
                url: item.url,
                guild_id: window.GUILD_ID,
                user_id: window.USER_ID
            };
            const res = await fetch("/api/play", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            });
            const resp = await res.json();
            if (!res.ok) throw resp.error || "Erreur API";

        } catch (err) {
            playError.style.display = "";
            playError.innerText = "Erreur : " + (err || "Impossible dâ€™ajouter ce son");
        }

        input.value = "";
        playBtn.disabled = false;
        isPlayingRequest = false;
    });

    // Ajoute un morceau Ã  la playlist affichÃ©e (optimiste)
    function addTrackToPlaylist(item) {
        const li = document.createElement("li");
        li.innerHTML = `<a href="${item.url}" target="_blank">${item.title}</a>`;
        playlistUl.appendChild(li);
    }

    // Mets Ã  jour la playlist depuis le serveur (via socket)
    function updatePlaylist(tracks) {
        playlistUl.innerHTML = "";
        if (!tracks || tracks.length === 0) {
            playlistUl.innerHTML = `<p><em>La playlist est vide. Comme votre inspiration.</em></p>`;
            return;
        }
        for (const item of tracks) {
            addTrackToPlaylist(item);
        }
    }

    // Mets Ã  jour le morceau en cours
    function updateCurrent(current) {
        const div = document.getElementById("current-song");
        if (current) {
            div.innerHTML = `ðŸŽ§ En lecture : <a href="${current.url}" target="_blank">${current.title}</a>`;
        } else {
            div.innerHTML = "";
        }
    }

    // == Socket.IO ==
    const socket = io();
    socket.on("playlist_update", function(data) {
        updatePlaylist(data.queue || []);
        updateCurrent(data.current);
    });

    </script>
</body>
</html>
