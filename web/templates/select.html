<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Sélection du serveur – Greg le Consanguin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
      window.USER_ID = "{{ user['id'] }}";
    </script>
</head>
<body>
    <div class="container">
        <img src="{{ url_for('static', filename='assets/greg.jpg') }}" alt="Greg le Consanguin" class="greg-face">
        <h1>Choisis ton serveur Discord</h1>
        <p class="sarcasme">Parce qu’il faut bien supporter tes choix douteux...</p>
        <form method="get" action="/panel" id="select-form">
            <label for="guild-select">Serveur :</label><br>
            <select id="guild-select" name="guild_id" required>
                {% for guild in guilds %}
                    <option value="{{ guild.id }}">{{ guild.name }}</option>
                {% endfor %}
            </select>
            <br>
            <label for="channel-select">Salon textuel :</label><br>
            <select id="channel-select" name="channel_id" required>
                <!-- Dynamique via JS -->
            </select>
            <br>
            <button type="submit">Accéder au Panel</button>
        </form>
        <a href="/logout"><button>Déconnexion</button></a>
    </div>
    <script>
const guildSelect = document.getElementById("guild-select");
const channelSelect = document.getElementById("channel-select");

function dbg(...args) { console.log("[GREG.js][SELECT]", ...args); }

function loadTextChannels(guildId) {
    fetch(`/api/text_channels?guild_id=${guildId}`)
        .then(r => r.json())
        .then(chans => {
            channelSelect.innerHTML = "";
            chans.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c.id;
                opt.innerText = c.name;
                channelSelect.appendChild(opt);
            });
            if (channelSelect.options.length)
                channelSelect.selectedIndex = 0;
            dbg("Salons textuels chargés:", chans);
        });
}

if (guildSelect && channelSelect) {
    guildSelect.addEventListener("change", function() {
        loadTextChannels(guildSelect.value);
    });
    // Chargement initial pour la valeur par défaut (premier serveur)
    if (guildSelect.value) {
        loadTextChannels(guildSelect.value);
    }
}
const submitBtn = document.querySelector("#select-form button[type='submit']");
if (submitBtn) submitBtn.disabled = true;

function loadTextChannels(guildId) {
    fetch(`/api/text_channels?guild_id=${guildId}`)
        .then(r => r.json())
        .then(chans => {
            channelSelect.innerHTML = "";
            chans.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c.id;
                opt.innerText = c.name;
                channelSelect.appendChild(opt);
            });
            submitBtn.disabled = !channelSelect.options.length;
            if (channelSelect.options.length)
                channelSelect.selectedIndex = 0;
            dbg("Salons textuels chargés:", chans);
        });
}

</script>

    <script src="{{ url_for('static', filename='greg.js') }}"></script>
</body>
</html>
